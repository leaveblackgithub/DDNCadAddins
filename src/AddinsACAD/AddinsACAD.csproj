<?xml version="1.0" encoding="utf-8"?>
<!--
ACADExampleTest.csproj - AutoCAD Unit Test Project File

Features:
1. Encapsulates test cases
2. References TestRunnerACAD library
3. Processes output TestLoader.scr script

This project is the main test project for the solution, responsible for executing all tests
-->
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Import the shared properties from Directory.props -->
  <Import Project="$(MSBuildThisFileDirectory)\..\Directory.props" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">DebugInApp</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProjectGuid>{0D9B48BE-20B0-4C41-880D-A42B2A491218}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <NuGetPackageImportStamp>
    </NuGetPackageImportStamp>
    <RootNamespace>AddinsACAD</RootNamespace>
    <AssemblyName>AddinsACAD</AssemblyName>
  </PropertyGroup>
  <!-- DebugInApp配置 -->
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'DebugInApp|AnyCPU' ">
  </PropertyGroup>
  <!-- DebugInAcCoreConsle配置 -->
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'DebugInAcCoreConsle|AnyCPU' ">
  </PropertyGroup>
  <!-- Release配置 -->
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
  </PropertyGroup>
  <ItemGroup>
    <!-- 系统引用已迁移到Directory.props -->
  </ItemGroup>
  <ItemGroup>
    <Compile Include="$(SolutionDir)CommonAssemblyInfo.cs">
      <Link>Properties\CommonAssemblyInfo.cs</Link>
    </Compile>
    <Compile Include="ExampleTestsInOtherProjects.cs" />
    <Compile Include="Properties\AssemblyInfo.cs" />
    <Compile Include="RunTestsCommand.cs" />
    <Compile Include="TestInApp\ExampleTestsInOtherProjects.cs" />
  </ItemGroup>
  <ItemGroup>
    <None Include="packages.config" />
    <None Include="TestDrawing.dwg">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Include="TestLoader.scr">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="$(SolutionDir)TestRunnerACAD\TestRunnerACAD.csproj">
      <Project>{e63bebf1-521b-4665-adae-c55e1c4898ce}</Project>
      <Name>TestRunnerACAD</Name>
      <Private>True</Private>
    </ProjectReference>
  </ItemGroup>
  <ItemGroup>
    <!-- 系统引用 -->
    <Reference Include="System" />
    <Reference Include="System.Core" />
    <Reference Include="System.Windows.Forms" />
    <Reference Include="System.Xml.Linq" />
    <Reference Include="System.Data.DataSetExtensions" />
    <Reference Include="Microsoft.CSharp" />
    <Reference Include="System.Data" />
    <Reference Include="System.Net.Http" />
    <Reference Include="System.Xml" />
    <!-- NUnit引用 -->
    <Reference Include="nunit.framework, Version=3.13.2.0, Culture=neutral, PublicKeyToken=2638cd05610744eb">
      <HintPath>$(SolutionDir)packages\NUnit.3.13.2\lib\net45\nunit.framework.dll</HintPath>
      <Private>True</Private>
    </Reference>
    <Reference Include="nunitlite, Version=3.13.2.0, Culture=neutral, PublicKeyToken=2638cd05610744eb">
      <HintPath>$(SolutionDir)packages\NUnitLite.3.13.2\lib\net45\nunitlite.dll</HintPath>
      <Private>True</Private>
    </Reference>
    <!-- AutoCAD引用 -->
    <Reference Include="AcCoreMgd">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>C:\Program Files\Autodesk\AutoCAD 2019\AcCoreMgd.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="AcDbMgd">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>C:\Program Files\Autodesk\AutoCAD 2019\AcDbMgd.dll</HintPath>
      <Private>False</Private>
    </Reference>
  </ItemGroup>
  <ItemGroup Condition=" '$(Configuration)|$(Platform)' == 'DebugInApp|AnyCPU' ">
    <!-- 仅在DebugInApp配置下引用的AutoCAD UI库 -->
    <Reference Include="acmgd">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>C:\Program Files\Autodesk\AutoCAD 2019\acmgd.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="AdWindows">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>C:\Program Files\Autodesk\AutoCAD 2019\AdWindows.dll</HintPath>
      <Private>False</Private>
    </Reference>
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <!-- Process SCR file, replace relative paths with absolute paths -->
  <Target Name="ProcessScrFile" AfterTargets="Build">
    <PropertyGroup>
      <ScrSourceFile>$(ProjectDir)TestLoader.scr</ScrSourceFile>
      <ScrTargetFile>$(OutputPath)TestLoader.scr</ScrTargetFile>
      <!-- Ensure paths use forward slash format -->
      <OutputPathForward>$(OutputPath.Replace('\', '/'))</OutputPathForward>
    </PropertyGroup>
    <!-- SCR file description (not written to file):
         1. Set trusted path to DLL directory
         2. Load test DLL
         3. Execute tests
         
         Note:
         - This file will be copied to output directory
         - AutoCAD does not support comments, so SCR file contains no comments
         - Only includes actual commands to execute
    -->
    <!-- Read SCR file content -->
    <ReadLinesFromFile File="$(ScrSourceFile)">
      <Output TaskParameter="Lines" ItemName="ScrFileLines" />
    </ReadLinesFromFile>
    <!-- Create temporary file with actual paths, without comments -->
    <WriteLinesToFile File="$(ScrTargetFile).temp" Lines="setvar&#xD;&#xA;trustedpaths&#xD;&#xA;$(OutputPathForward)&#xD;&#xA;netload $(OutputPathForward)AddinsACAD.dll&#xD;&#xA;RunTests" Overwrite="true" />
    <!-- Replace target file with temporary file -->
    <Copy SourceFiles="$(ScrTargetFile).temp" DestinationFiles="$(ScrTargetFile)" />
    <Delete Files="$(ScrTargetFile).temp" />
    <Message Text="Processed SCR file, replaced relative paths with absolute paths: $(ScrTargetFile)" Importance="high" />
    <Message Text="SCR file function: Set trusted paths, load DLL, execute tests" Importance="high" />
  </Target>
  <!-- Automatically generate debug settings, using absolute paths -->
  <Target Name="GenerateDebugSettings" AfterTargets="ProcessScrFile">
    <PropertyGroup>
      <!-- AutoCAD paths -->
      <AcadFullPath>C:/Program Files/Autodesk/AutoCAD 2019/acad.exe</AcadFullPath>
      <AcadCorePath>C:/Program Files/Autodesk/AutoCAD 2019/accoreconsole.exe</AcadCorePath>
      <!-- Get full absolute path for output path -->
      <OutputPathAbs>$([System.IO.Path]::GetFullPath('$(OutputPath)').Replace('\', '/'))</OutputPathAbs>
      <!-- Get full absolute path for SCR file -->
      <ScrFileAbs>$([System.IO.Path]::GetFullPath('$(OutputPath)TestLoader.scr').Replace('\', '/'))</ScrFileAbs>
      <!-- Output user settings file -->
      <UserFile>$(ProjectDir)$(MSBuildProjectName).csproj.user</UserFile>
    </PropertyGroup>
    <Message Text="Calculated absolute paths:" Importance="high" />
    <Message Text="Output directory: $(OutputPathAbs)" Importance="high" />
    <Message Text="SCR file: $(ScrFileAbs)" Importance="high" />
    <!-- Create custom user settings file template -->
    <WriteLinesToFile File="$(UserFile).temp" Lines="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#xD;&#xA;&lt;!--&#xD;&#xA;Automatically generated debug settings file - $(MSBuildProjectName).csproj.user&#xD;&#xA;Generation time: $([System.DateTime]::Now)&#xD;&#xA;&#xD;&#xA;Features:&#xD;&#xA;1. Configure AutoCAD debug settings using full absolute paths&#xD;&#xA;2. Automatically set startup parameters and working directory&#xD;&#xA;&#xD;&#xA;Notes:&#xD;&#xA;- This file is automatically generated by the build process&#xD;&#xA;- All paths use AutoCAD-compatible forward slash (/) format&#xD;&#xA;- Command line arguments use forward slash (/s) as option flags&#xD;&#xA;- Working directory is set to solution output path&#xD;&#xA;- Do not modify manually, modifications will be overwritten in the next build&#xD;&#xA;--&gt;&#xD;&#xA;&lt;Project ToolsVersion=&quot;Current&quot; xmlns=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&gt;&#xD;&#xA;  &lt;PropertyGroup Condition=&quot;'%24(Configuration)|%24(Platform)' == 'DebugInApp|AnyCPU'&quot;&gt;&#xD;&#xA;    &lt;StartAction&gt;Program&lt;/StartAction&gt;&#xD;&#xA;    &lt;StartProgram&gt;$(AcadFullPath)&lt;/StartProgram&gt;&#xD;&#xA;  &lt;/PropertyGroup&gt;&#xD;&#xA;  &lt;PropertyGroup Condition=&quot;'%24(Configuration)|%24(Platform)' == 'DebugInAcCoreConsle|AnyCPU'&quot;&gt;&#xD;&#xA;    &lt;StartAction&gt;Program&lt;/StartAction&gt;&#xD;&#xA;    &lt;StartProgram&gt;$(AcadCorePath)&lt;/StartProgram&gt;&#xD;&#xA;    &lt;StartArguments&gt;/s &quot;$(ScrFileAbs)&quot;&lt;/StartArguments&gt;&#xD;&#xA;    &lt;StartWorkingDirectory&gt;$(OutputPathAbs)&lt;/StartWorkingDirectory&gt;&#xD;&#xA;  &lt;/PropertyGroup&gt;&#xD;&#xA;  &lt;PropertyGroup&gt;&#xD;&#xA;    &lt;ProjectView&gt;ShowAllFiles&lt;/ProjectView&gt;&#xD;&#xA;  &lt;/PropertyGroup&gt;&#xD;&#xA;&lt;/Project&gt;" Overwrite="true" />
    <!-- Replace user settings file -->
    <Copy SourceFiles="$(UserFile).temp" DestinationFiles="$(UserFile)" />
    <Delete Files="$(UserFile).temp" />
    <Message Text="Generated debug settings using absolute paths: $(UserFile)" Importance="high" />
  </Target>
  <Target Name="EnsureNuGetPackageBuildImports" BeforeTargets="PrepareForBuild">
    <PropertyGroup>
      <ErrorText>This computer is missing NuGet packages referenced by this project. Use "NuGet Package Restore" to download these packages. For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is {0}.</ErrorText>
    </PropertyGroup>
    <Error Condition="!Exists('$(SolutionDir)packages\NUnit.3.13.2\build\NUnit.props')" Text="$([System.String]::Format('$(ErrorText)', '$(SolutionDir)packages\NUnit.3.13.2\build\NUnit.props'))" />
  </Target>
</Project>